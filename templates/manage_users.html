<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление пользователями</title>
    <link rel="stylesheet" href="static/css/main.css">
</head>
<body>
    <nav class="navbar">
        <ul class="navbar-left">
            <li class="navbarli">
                <a href="{% if session.get('login') %}/home{% else %}#{% endif %}">
                    <img src="../static/icons/home_icon.png" alt="Главное меню" class="navbar-icon">
                </a>
            </li>
        </ul>
        <ul class="navbar-right">
            <li class="navbarli"><a href="/view_user">{{ session['login'] }}</a></li>
            <li class="navbarli"><a href="/logout">Выйти</a></li>
        </ul>
    </nav>

    <div class="breadcrumbs">
        <a href="/home">Главная</a>
        <span>/</span>
        <span>Управление пользователями</span>
    </div>

    <main>
        <div class="container">
            <h1>Управление пользователями</h1>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Поиск...">
            </div>
            <table id="userTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">ID</th>
                        <th onclick="sortTable(1)">ФИО</th>
                        <th onclick="sortTable(2)">Логин</th>
                        <th onclick="sortTable(3)">Роль</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% set role_names = {
                        'admin': 'Администратор',
                        'project_manager': 'Руководитель проекта',
                        'specialist': 'Специалист'
                    } %}
    
                    {% for user in users %}
                    <tr>
                        <td>{{ user['id'] }}</td>
                        <td>{{ user['fullname'] }}</td>
                        <td>{{ user['login'] }}</td>
                        <td>{{ role_names[user['role']] }}</td>
                        <td>
                            <a href="/edit_user/{{ user['id'] }}">Редактировать</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="pagination"></div>
        </div>
    </main>
    <footer class="footer">
        <p>
            <a href="https://www.flaticon.com/free-icons/projects" title="projects icons">Projects icons created by itim2101 - Flaticon</a>
        </p>
    </footer>
    <script>
        // Получаем сообщения из Flask
        const messages = {{ get_flashed_messages(with_categories=true) | tojson | safe }};
        if (messages.length > 0) {
            messages.forEach(([category, message]) => {
                alert(message); // Используем стандартное всплывающее окно
            });
        }

        const rowsPerPage = 10;
        let currentPage = 1;
        let allRows = []; // Хранит все строки таблицы
        let filteredRows = []; // Хранит отфильтрованные строки

        function initializeTable() {
            const table = document.getElementById('userTable');
            const rows = Array.from(table.getElementsByTagName('tbody')[0].getElementsByTagName('tr'));
            allRows = rows; // Сохраняем все строки таблицы
            filteredRows = [...allRows]; // Изначально все строки отображаются
            paginateTable(filteredRows.length);
        }

        function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            if (searchInput === '') {
                filteredRows = [...allRows]; // Если поле поиска пустое, отображаем все строки
            } else {
                filteredRows = allRows.filter(row => {
                    const cells = row.getElementsByTagName('td');
                    return Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(searchInput));
                });
            }

            currentPage = 1; // Сбрасываем на первую страницу после фильтрации
            updateTable(filteredRows);
            paginateTable(filteredRows.length);
        }

        function sortTable(columnIndex) {
            const isAscending = document.getElementById('userTable').getAttribute('data-sort-order') === 'asc';
            document.getElementById('userTable').setAttribute('data-sort-order', isAscending ? 'desc' : 'asc');

            filteredRows.sort((a, b) => {
                const aText = a.getElementsByTagName('td')[columnIndex].textContent.trim();
                const bText = b.getElementsByTagName('td')[columnIndex].textContent.trim();

                // Если это числовая колонка (ID), сортируем как числа
                const aValue = columnIndex === 0 ? parseInt(aText, 10) || 0 : aText.toLowerCase();
                const bValue = columnIndex === 0 ? parseInt(bText, 10) || 0 : bText.toLowerCase();

                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });

            updateTable(filteredRows);
            paginateTable(filteredRows.length);
        }

        function updateTable(rows) {
            const tableBody = document.getElementById('userTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));
        }

        function paginateTable(totalRows) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            filteredRows.forEach((row, index) => {
                row.style.display = index >= start && index < end ? '' : 'none';
            });

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === currentPage ? 'active' : '';
                pageButton.onclick = () => {
                    currentPage = i;
                    paginateTable(totalRows);
                };
                pagination.appendChild(pageButton);
            }
        }

        document.getElementById('searchInput').addEventListener('input', filterTable);
        window.onload = initializeTable;
    </script>
</body>
</html>