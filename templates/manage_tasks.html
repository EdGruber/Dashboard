<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление задачами</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <nav class="navbar">
        <ul class="navbar-left">
            <li class="navbarli">
                <a href="{% if session.get('login') %}/home{% else %}#{% endif %}">
                    <img src="../static/icons/home_icon.png" alt="Главное меню" class="navbar-icon">
                </a>
            </li>
        </ul>
        <ul class="navbar-right">
            <li class="navbarli"><a href="/view_user">{{ session['login'] }}</a></li>
            <li class="navbarli"><a href="/logout">Выйти</a></li>
        </ul>
    </nav>

    <div class="breadcrumbs">
        <a href="/home">Главная</a>
        <span>/</span>
        <span>Управление задачами</span>
    </div>

    <main>
        <div class="container">
            <h1>Управление задачами</h1>

            <div class="search-filter-wrapper">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Поиск...">
                </div>

                <div class="filter-buttons">
                    <button id="toggleFilters" class="button">Показать фильтры</button>
                </div>
            </div>

            <div id="filters" class="filter-container" style="display: none;">
                <div>
                    <label for="statusFilter">Статус:</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="">Все</option>
                        {% for status in statuses %}
                        <option value="{{ status['name'] }}">{{ status['name'] }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="specialistFilter">Исполнитель:</label>
                    <select id="specialistFilter" onchange="filterTable()">
                        <option value="">Все</option>
                        {% for user in users %}
                        <option value="{{ user['fullname'] }}">{{ user['fullname'] }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="projectFilter">Проект:</label>
                    <select id="projectFilter" onchange="filterTable()">
                        <option value="">Все</option>
                        {% for project in projects %}
                        <option value="{{ project['name'] }}">{{ project['name'] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {% if role in ['admin', 'project_manager'] %}
                <a href="/create_task" class="button">Создать задачу</a>
            {% endif %}

            <h2>Список задач</h2>
            <table id="taskTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Номер</th>
                        <th onclick="sortTable(1)">Тема</th>
                        <th onclick="sortTable(2)">Исполнитель</th>
                        <th onclick="sortTable(3)">Статус</th>
                        <th onclick="sortTable(4)">Проект</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task['task_id'] }}</td> 
                        <td>{{ task['task_title'] }}</td> 
                        <td>{{ task['specialist_name'] }}</td>
                        <td>{{ task['status_name'] }}</td>
                        <td>{{ task['project_name'] }}</td>
                        <td>
                            <a href="{{ url_for('view_task', task_id=task['task_id']) }}">Посмотреть задачу</a>
                            <br><br>
                            <a href="{{ url_for('edit_task', task_id=task['task_id']) }}">Редактировать</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6">Задачи не найдены.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="pagination"></div>
        </div>
    </main>
    <footer class="footer">
        <p>
            <a href="https://www.flaticon.com/free-icons/projects" title="projects icons">Projects icons created by itim2101 - Flaticon</a>
        </p>
    </footer>
    <script>
        // Получаем сообщения из Flask
        const messages = {{ get_flashed_messages(with_categories=true) | tojson | safe }};
        if (messages.length > 0) {
            messages.forEach(([category, message]) => {
                alert(message); // Используем стандартное всплывающее окно
            });
        }
        
        const rowsPerPage = 10;
        let currentPage = 1;
        let allRows = [];
        let filteredRows = [];

        function initializeTable() {
            const table = document.getElementById('taskTable');
            const rows = Array.from(table.getElementsByTagName('tbody')[0].getElementsByTagName('tr'));
            allRows = rows;
            filteredRows = [...allRows];
            paginateTable(filteredRows.length);
        }

        function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const specialistFilter = document.getElementById('specialistFilter').value.toLowerCase();
            const projectFilter = document.getElementById('projectFilter').value.toLowerCase();

            filteredRows = allRows.filter(row => {
                const cells = row.getElementsByTagName('td');
                const matchesSearch = Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(searchInput));
                const matchesStatus = statusFilter === '' || cells[3].textContent.toLowerCase() === statusFilter;
                const matchesSpecialist = specialistFilter === '' || cells[2].textContent.toLowerCase() === specialistFilter;
                const matchesProject = projectFilter === '' || cells[4].textContent.toLowerCase() === projectFilter;

                return matchesSearch && matchesStatus && matchesSpecialist && matchesProject;
            });

            currentPage = 1;
            updateTable(filteredRows);
            paginateTable(filteredRows.length);
        }

        function sortTable(columnIndex) {
            const isAscending = document.getElementById('taskTable').getAttribute('data-sort-order') === 'asc';
            document.getElementById('taskTable').setAttribute('data-sort-order', isAscending ? 'desc' : 'asc');

            filteredRows.sort((a, b) => {
                const aText = a.getElementsByTagName('td')[columnIndex].textContent.trim();
                const bText = b.getElementsByTagName('td')[columnIndex].textContent.trim();

                // Если это числовая колонка, сортируем как числа
                const aValue = columnIndex === 0 ? parseInt(aText, 10) || 0 : aText.toLowerCase();
                const bValue = columnIndex === 0 ? parseInt(bText, 10) || 0 : bText.toLowerCase();

                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });

            updateTable(filteredRows);
            paginateTable(filteredRows.length);
        }

        function updateTable(rows) {
            const tableBody = document.getElementById('taskTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));
        }

        function paginateTable(totalRows) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            filteredRows.forEach((row, index) => {
                row.style.display = index >= start && index < end ? '' : 'none';
            });

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === currentPage ? 'active' : '';
                pageButton.onclick = () => {
                    currentPage = i;
                    paginateTable(totalRows);
                };
                pagination.appendChild(pageButton);
            }
        }

        document.getElementById('searchInput').addEventListener('input', filterTable);
        window.onload = initializeTable;

        document.getElementById('toggleFilters').addEventListener('click', () => {
            const filters = document.getElementById('filters');
            const isVisible = filters.style.display === 'block';
            filters.style.display = isVisible ? 'none' : 'block';
            document.getElementById('toggleFilters').textContent = isVisible ? 'Показать фильтры' : 'Скрыть фильтры';
        });
    </script>
</body>
</html>